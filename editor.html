<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Runbook Editor (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
        window.Octokit = Octokit;
    </script>
</head>
<body class="bg-light p-4">

<div class="container bg-white p-5 rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ› ï¸ Runbook ç·¨è¼¯å™¨</h2>
        <button class="btn btn-success" onclick="saveToGitHub()">ğŸ’¾ å„²å­˜åˆ° GitHub</button>
    </div>

    <div class="alert alert-warning">
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="ghToken" class="form-control form-control-sm" placeholder="GitHub Token (ghp_...)">
            </div>
            <div class="col-md-3">
                <input type="text" id="ghOwner" class="form-control form-control-sm" placeholder="Username (Owner)">
            </div>
            <div class="col-md-3">
                <input type="text" id="ghRepo" class="form-control form-control-sm" placeholder="Repo Name">
            </div>
             <div class="col-md-3">
                <button onclick="loadFromGitHub()" class="btn btn-sm btn-outline-dark w-100">ğŸ“¥ è¼‰å…¥ç¾æœ‰è³‡æ–™</button>
            </div>
        </div>
        <small class="text-muted">Token åƒ…å­˜åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ä¸­ï¼Œä¸æœƒå¤–æ´©ã€‚è«‹ç¢ºä¿ Repo æœ‰ `data.json` æª”æ¡ˆã€‚</small>
    </div>

    <hr>

    <div class="mb-3">
        <label>Runbook æ¨™é¡Œ</label>
        <input type="text" id="newTitle" class="form-control" placeholder="ä¾‹å¦‚: Payment Timeout SOP">
    </div>

    <div id="stepsArea">
        </div>

    <button class="btn btn-outline-primary mt-3 w-100" onclick="addStep()">+ æ–°å¢æ­¥é©Ÿ</button>

</div>

<script type="module">
    let currentData = []; // å„²å­˜æ‰€æœ‰çš„ SOP

    window.addStep = function() {
        const div = document.createElement('div');
        div.className = "card p-3 mb-3 border-secondary step-item";
        div.innerHTML = `
            <div class="mb-2">
                <label class="fw-bold">æ­¥é©Ÿé¡å‹</label>
                <select class="form-select step-type" onchange="toggleFields(this)">
                    <option value="info">ç´”æ–‡å­—æŒ‡å¼• (Instruction)</option>
                    <option value="command">åŸ·è¡ŒæŒ‡ä»¤ (Command)</option>
                    <option value="decision">æ±ºç­–é¸é … (Decision)</option>
                </select>
            </div>
            <div class="mb-2">
                <label>æ­¥é©Ÿæ¨™é¡Œ</label>
                <input type="text" class="form-control step-title" placeholder="ä¾‹å¦‚: æª¢æŸ¥ Log">
            </div>
            <div class="mb-2">
                <label>è©³ç´°èªªæ˜</label>
                <textarea class="form-control step-desc"></textarea>
            </div>
            <div class="mb-2 cmd-field hidden">
                <label>æŒ‡ä»¤ä»£ç¢¼</label>
                <input type="text" class="form-control step-cmd" placeholder="grep error...">
            </div>
            <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">åˆªé™¤æ­¥é©Ÿ</button>
        `;
        document.getElementById('stepsArea').appendChild(div);
    }

    window.toggleFields = function(select) {
        const parent = select.closest('.card');
        const cmdField = parent.querySelector('.cmd-field');
        if (select.value === 'command') {
            cmdField.classList.remove('hidden');
        } else {
            cmdField.classList.add('hidden');
        }
    }

    // å„²å­˜é‚è¼¯
    window.saveToGitHub = async function() {
        const token = document.getElementById('ghToken').value;
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;

        if(!token || !owner || !repo) {
            alert("è«‹å¡«å¯« GitHub è³‡è¨Šï¼");
            return;
        }

        // 1. æ”¶é›†ç•«é¢ä¸Šçš„è³‡æ–™
        const newSop = {
            title: document.getElementById('newTitle').value,
            steps: []
        };

        document.querySelectorAll('.step-item').forEach(item => {
            const type = item.querySelector('.step-type').value;
            const step = {
                title: item.querySelector('.step-title').value,
                desc: item.querySelector('.step-desc').value,
                type: type
            };
            if(type === 'command') {
                step.cmd = item.querySelector('.step-cmd').value;
            }
            newSop.steps.push(step);
        });

        // åŠ å…¥ç¾æœ‰è³‡æ–™ (ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡å…ˆå‡è¨­åª append ä¸€ç­†)
        currentData.push(newSop);
        const jsonString = JSON.stringify(currentData, null, 2);
        
        // 2. é€é API å¯«å…¥ GitHub
        const octokit = new window.Octokit({ auth: token });
        
        try {
            // å…ˆæ‹¿ SHA (GitHub ä¿®æ”¹æª”æ¡ˆéœ€è¦å…ˆçŸ¥é“æª”æ¡ˆç›®å‰çš„æŒ‡ç´‹)
            const { data: fileData } = await octokit.rest.repos.getContent({
                owner, repo, path: "data.json"
            });
            
            // æ›´æ–°æª”æ¡ˆ
            await octokit.rest.repos.createOrUpdateFileContents({
                owner, repo, path: "data.json",
                message: "Update SOP via Web Editor",
                content: btoa(unescape(encodeURIComponent(jsonString))), // Base64 ç·¨ç¢¼ (æ”¯æ´ä¸­æ–‡)
                sha: fileData.sha
            });
            
            alert("âœ… å„²å­˜æˆåŠŸï¼Runbook å·²æ›´æ–°ï¼");
        } catch (e) {
            console.error(e);
            alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console Log (å¯èƒ½æ˜¯ Token æ¬Šé™ä¸è¶³æˆ–æª”æ¡ˆä¸å­˜åœ¨)");
        }
    }
    
    // åˆå§‹åŒ–è¼‰å…¥
    window.loadFromGitHub = async function() {
        const token = document.getElementById('ghToken').value;
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;
        
        if(!token) { alert("è«‹è¼¸å…¥ Token"); return; }

        const octokit = new window.Octokit({ auth: token });
        try {
            const { data } = await octokit.rest.repos.getContent({
                owner, repo, path: "data.json"
            });
            // Decode Content
            const content = decodeURIComponent(escape(atob(data.content)));
            currentData = JSON.parse(content);
            alert(`å·²è¼‰å…¥ ${currentData.length} ç­† SOPï¼Œç›®å‰é€™æ˜¯ã€Œæ–°å¢ã€æ¨¡å¼ã€‚`);
        } catch (e) {
            alert("è®€å–å¤±æ•—æˆ–æ˜¯æ–° Repo (å°šæœªæœ‰ data.json)");
            currentData = [];
        }
    }
</script>

<style>
    .hidden { display: none; }
</style>
</body>
</html>
