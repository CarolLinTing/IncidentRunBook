<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Runbook Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
        window.Octokit = Octokit;
    </script>
</head>
<body class="bg-light">

<nav class="navbar navbar-light bg-white border-bottom shadow-sm px-4">
    <a href="index.html" class="btn btn-outline-secondary">â† è¿”å›é¦–é  (Home)</a>
    <span class="navbar-brand mb-0 h1 mx-auto">ğŸ› ï¸ Runbook å…§å®¹ç·¨è¼¯å™¨</span>
    <button class="btn btn-success" onclick="saveToGitHub()">ğŸ’¾ å„²å­˜è®Šæ›´ (Save)</button>
</nav>

<div class="container mt-4">
    
    <div class="accordion mb-4" id="configArea">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig">
                    ğŸ” GitHub è¨­å®š (é»æ­¤å±•é–‹ä»¥é€£ç·š)
                </button>
            </h2>
            <div id="collapseConfig" class="accordion-collapse collapse" data-bs-parent="#configArea">
                <div class="accordion-body">
                    <div class="row g-2">
                        <div class="col-md-4"><input type="text" id="ghToken" class="form-control" placeholder="Token (ghp_...)"></div>
                        <div class="col-md-3"><input type="text" id="ghOwner" class="form-control" placeholder="Username"></div>
                        <div class="col-md-3"><input type="text" id="ghRepo" class="form-control" placeholder="Repo Name"></div>
                        <div class="col-md-2"><button onclick="loadFromGitHub()" class="btn btn-primary w-100">ğŸ“¥ è¼‰å…¥</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="list-group" id="sopList">
                </div>
            <button class="btn btn-outline-primary w-100 mt-2" onclick="createNewSop()">+ æ–°å¢ SOP</button>
        </div>

        <div class="col-md-8">
            <div class="card p-4 shadow-sm" id="editorCard">
                <div class="mb-3">
                    <label class="form-label">Title (SOP æ¨™é¡Œ)</label>
                    <input type="text" class="form-control fw-bold" id="editTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Tags (é—œéµå­—ï¼Œç”¨é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" class="form-control" id="editTags" placeholder="e.g. payment, timeout">
                </div>
                
                <hr>
                <h6>æ­¥é©Ÿ (Steps)</h6>
                <div id="stepsArea" class="mb-3"></div>
                
                <button class="btn btn-secondary btn-sm" onclick="addStepItem()">+ å¢åŠ æ­¥é©Ÿ</button>
                <button class="btn btn-danger btn-sm float-end" onclick="deleteCurrentSop()">ğŸ—‘ï¸ åˆªé™¤æ­¤ SOP</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    let allSops = [];
    let currentIndex = -1;

    // é è¨­å…ˆè®€å–æœ¬åœ° data.json æ–¹ä¾¿æ¸¬è©¦
    fetch('data.json').then(r => r.json()).then(data => {
        allSops = data;
        renderSopList();
    }).catch(e => console.log("ç­‰å¾… GitHub è¼‰å…¥..."));

    // 1. æ¸²æŸ“å·¦å´åˆ—è¡¨
    window.renderSopList = function() {
        const list = document.getElementById('sopList');
        list.innerHTML = '';
        allSops.forEach((sop, idx) => {
            const a = document.createElement('a');
            a.className = `list-group-item list-group-item-action ${idx === currentIndex ? 'active' : ''}`;
            a.innerText = sop.title;
            a.onclick = () => loadSopToEditor(idx);
            list.appendChild(a);
        });
    }

    // 2. è¼‰å…¥ SOP åˆ°å³å´ç·¨è¼¯å™¨
    window.loadSopToEditor = function(idx) {
        currentIndex = idx;
        const sop = allSops[idx];
        document.getElementById('editTitle').value = sop.title;
        document.getElementById('editTags').value = sop.tags ? sop.tags.join(',') : '';
        
        const stepsArea = document.getElementById('stepsArea');
        stepsArea.innerHTML = '';
        sop.steps.forEach(step => addStepItem(step));
        
        renderSopList(); // æ›´æ–°åˆ—è¡¨é¸å–ç‹€æ…‹
    }

    // 3. å¢åŠ ä¸€å€‹æ­¥é©Ÿ UI
    window.addStepItem = function(stepData = null) {
        const div = document.createElement('div');
        div.className = "card p-3 mb-2 bg-light border step-item";
        div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
                <select class="form-select form-select-sm w-auto step-type" onchange="toggleFields(this)">
                    <option value="info">æ–‡å­—æŒ‡å¼• (Info)</option>
                    <option value="command">åŸ·è¡ŒæŒ‡ä»¤ (Command)</option>
                    <option value="decision">æ±ºç­–é¸é … (Decision)</option>
                </select>
                <button class="btn btn-close" onclick="this.closest('.step-item').remove()"></button>
            </div>
            <input type="text" class="form-control form-control-sm mb-2 step-title" placeholder="æ­¥é©Ÿåç¨±" value="${stepData?.title || ''}">
            <textarea class="form-control form-control-sm mb-2 step-desc" placeholder="è©³ç´°èªªæ˜" rows="2">${stepData?.desc || ''}</textarea>
            
            <div class="field-cmd hidden">
                <input type="text" class="form-control form-control-sm font-monospace step-cmd" placeholder="Command (e.g., grep error)" value="${stepData?.cmd || ''}">
            </div>
            <div class="field-options hidden">
                <input type="text" class="form-control form-control-sm step-options" placeholder="é¸é … (ç”¨é€—è™Ÿéš”é–‹: A,B,C)" value="${stepData?.options ? stepData.options.join(',') : ''}">
            </div>
        `;
        
        // æ ¹æ“šé¡å‹é¡¯ç¤ºæ¬„ä½
        const typeSelect = div.querySelector('.step-type');
        if(stepData) typeSelect.value = stepData.type;
        document.getElementById('stepsArea').appendChild(div);
        toggleFields(typeSelect); // åˆå§‹åŒ–é¡¯ç¤º
    }

    window.toggleFields = function(select) {
        const parent = select.closest('.step-item');
        const cmdField = parent.querySelector('.field-cmd');
        const optField = parent.querySelector('.field-options');
        
        cmdField.classList.add('hidden');
        optField.classList.add('hidden');
        
        if (select.value === 'command') cmdField.classList.remove('hidden');
        if (select.value === 'decision') optField.classList.remove('hidden');
    }

    window.createNewSop = function() {
        allSops.push({ title: "New Incident SOP", tags: [], steps: [] });
        loadSopToEditor(allSops.length - 1);
    }

    window.deleteCurrentSop = function() {
        if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) {
            allSops.splice(currentIndex, 1);
            currentIndex = -1;
            document.getElementById('stepsArea').innerHTML = '';
            document.getElementById('editTitle').value = '';
            renderSopList();
        }
    }

    // 4. å„²å­˜å› Data (åŒ…å« GitHub é‚è¼¯)
    window.saveToGitHub = async function() {
        // å…ˆæŠŠç·¨è¼¯å™¨ç›®å‰çš„ç‹€æ…‹å­˜å› allSops
        if(currentIndex >= 0) {
            const sop = allSops[currentIndex];
            sop.title = document.getElementById('editTitle').value;
            sop.tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t=>t);
            sop.steps = [];
            
            document.querySelectorAll('.step-item').forEach(item => {
                const type = item.querySelector('.step-type').value;
                const s = {
                    type: type,
                    title: item.querySelector('.step-title').value,
                    desc: item.querySelector('.step-desc').value
                };
                if(type === 'command') s.cmd = item.querySelector('.step-cmd').value;
                if(type === 'decision') s.options = item.querySelector('.step-options').value.split(',').map(o=>o.trim());
                sop.steps.push(s);
            });
        }

        const token = document.getElementById('ghToken').value;
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;

        if(!token) {
            console.log("æœ¬åœ°æ¸¬è©¦æ¨¡å¼ï¼Œè³‡æ–™å·²æ›´æ–°æ–¼è¨˜æ†¶é«”:", allSops);
            alert("âš ï¸ æœªè¼¸å…¥ Tokenï¼Œåƒ…æš«å­˜åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ä¸­ (F5 å¾Œæœƒæ¶ˆå¤±)ã€‚\nè«‹è¼¸å…¥ Token ä»¥å­˜å› GitHubã€‚");
            return;
        }

        // GitHub API Save
        const octokit = new window.Octokit({ auth: token });
        try {
            // å–å¾— SHA
            let sha = null;
            try {
                const { data } = await octokit.rest.repos.getContent({ owner, repo, path: "data.json" });
                sha = data.sha;
            } catch(e) {} // æª”æ¡ˆå¯èƒ½ä¸å­˜åœ¨

            // Update
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(allSops, null, 2))));
            await octokit.rest.repos.createOrUpdateFileContents({
                owner, repo, path: "data.json",
                message: "Update Runbooks via Web Editor",
                content: content,
                sha: sha
            });
            alert("âœ… å„²å­˜æˆåŠŸï¼GitHub å·²æ›´æ–°ï¼");
        } catch(e) {
            console.error(e);
            alert("âŒ å„²å­˜å¤±æ•—: " + e.message);
        }
    }
    
    // å¾ GitHub è®€å–
    window.loadFromGitHub = async function() {
        const token = document.getElementById('ghToken').value;
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;
        if(!token) return alert("è«‹è¼¸å…¥ Token");
        
        const octokit = new window.Octokit({ auth: token });
        try {
            const { data } = await octokit.rest.repos.getContent({ owner, repo, path: "data.json" });
            const json = decodeURIComponent(escape(atob(data.content)));
            allSops = JSON.parse(json);
            renderSopList();
            alert("å·²å¾ GitHub è¼‰å…¥æœ€æ–°è³‡æ–™ï¼");
        } catch(e) {
            alert("è®€å–å¤±æ•— (å¯èƒ½æ˜¯æ–° Repo é‚„æ²’æª”æ¡ˆ)");
        }
    }

</script>
<style>.hidden { display: none; }</style>
</body>
</html>
