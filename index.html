<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>L2 Runbook Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .step-active { border-left: 5px solid #0d6efd; background: #fff; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container" style="max-width: 800px;">
    <h2 class="mb-4 text-primary">ğŸ¦ Ops Runbook Center</h2>
    
    <div class="card p-3 mb-4">
        <label class="form-label fw-bold">ğŸ” æœå°‹ Incident é—œéµå­—</label>
        <select id="sopSelect" class="form-select" onchange="loadSop()">
            <option value="">è«‹é¸æ“‡å ´æ™¯...</option>
            </select>
    </div>

    <div id="runbookArea" class="hidden">
        <div class="card p-4">
            <h3 id="sopTitle"></h3>
            <hr>
            <div id="stepContainer"></div>
        </div>
        
        <div class="card p-4 mt-3 bg-dark text-white hidden" id="reportCard">
            <h5>ğŸ“‹ ServiceNow Output</h5>
            <textarea id="finalReport" class="form-control bg-secondary text-white" rows="6"></textarea>
            <button class="btn btn-success mt-2" onclick="copyReport()">è¤‡è£½å…§å®¹</button>
        </div>
    </div>
</div>

<script>
    let sops = [];
    let currentSop = null;
    let historyLog = [];

    // 1. è®€å– GitHub ä¸Šçš„ JSON è³‡æ–™ (ä½ çš„è³‡æ–™åº«)
    // é€™è£¡å‡è¨­ data.json è·Ÿ html åœ¨åŒä¸€å±¤
    fetch('data.json')
        .then(response => response.json())
        .then(data => {
            sops = data;
            const select = document.getElementById('sopSelect');
            sops.forEach((sop, index) => {
                let opt = document.createElement('option');
                opt.value = index;
                opt.innerText = sop.title;
                select.appendChild(opt);
            });
        });

    function loadSop() {
        const index = document.getElementById('sopSelect').value;
        if (index === "") return;
        
        currentSop = sops[index];
        document.getElementById('runbookArea').classList.remove('hidden');
        document.getElementById('sopTitle').innerText = currentSop.title;
        document.getElementById('stepContainer').innerHTML = '';
        historyLog = []; // é‡ç½®ç´€éŒ„
        renderStep(0);
    }

    function renderStep(stepIndex) {
        if (stepIndex >= currentSop.steps.length) {
            generateReport();
            return;
        }

        const step = currentSop.steps[stepIndex];
        const container = document.getElementById('stepContainer');
        
        const div = document.createElement('div');
        div.className = "mb-4 step-active p-3 rounded";
        div.innerHTML = `<h5>Step ${stepIndex + 1}: ${step.title}</h5><p>${step.desc}</p>`;

        if (step.type === 'command') {
            div.innerHTML += `<div class="bg-light p-2 font-monospace mb-2 border">${step.cmd}</div>`;
            div.innerHTML += `<textarea class="form-control mb-2" id="input_${stepIndex}" placeholder="è²¼ä¸ŠåŸ·è¡Œçµæœ..."></textarea>`;
            div.innerHTML += `<button class="btn btn-primary btn-sm" onclick="nextStep(${stepIndex}, 'input')">ä¸‹ä¸€æ­¥</button>`;
        } else if (step.type === 'decision') {
            step.options.forEach(opt => {
                div.innerHTML += `<button class="btn btn-outline-primary me-2" onclick="nextStep(${stepIndex}, 'decision', '${opt}')">${opt}</button>`;
            });
        } else {
            div.innerHTML += `<button class="btn btn-primary btn-sm" onclick="nextStep(${stepIndex}, 'info')">ä¸‹ä¸€æ­¥</button>`;
        }

        container.appendChild(div);
    }

    function nextStep(index, type, value) {
        const step = currentSop.steps[index];
        let log = `Step: ${step.title}\n`;
        
        if (type === 'input') {
            const val = document.getElementById(`input_${index}`).value;
            log += `Result: ${val}`;
        } else if (type === 'decision') {
            log += `Decision: ${value}`;
        }
        
        historyLog.push(log);
        
        // é–å®šä¸Šä¸€æ­¥
        const oldInputs = document.querySelectorAll(`#input_${index}, button`);
        // ç°¡å–®éš±è—æˆ–è®Šç° (é€™è£¡ç°¡ç•¥)

        renderStep(index + 1);
    }

    function generateReport() {
        const report = `[Incident] ${currentSop.title}\n\n[Process Log]\n` + historyLog.join('\n\n') + `\n\n[Status]\nResolved according to Runbook.`;
        document.getElementById('finalReport').value = report;
        document.getElementById('reportCard').classList.remove('hidden');
    }
    
    function copyReport() {
        navigator.clipboard.writeText(document.getElementById('finalReport').value);
        alert("å·²è¤‡è£½ï¼");
    }
</script>
</body>
</html>
