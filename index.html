<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>L1/L2 Support Runbook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; }
        .search-box { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; padding: 15px; font-size: 1.1rem; }
        .sop-card { cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .sop-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 5px solid #0d6efd; }
        .console-bg { background: #212529; color: #50fa7b; font-family: 'Consolas', monospace; padding: 15px; border-radius: 5px; }
        .hidden { display: none !important; }
        .step-completed { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">ğŸ¦ Ops Runbook Center</a>
        <div class="d-flex">
            <a href="editor.html" class="btn btn-outline-info btn-sm">âš™ï¸ é€²å…¥ç·¨è¼¯æ¨¡å¼ (Editor)</a>
        </div>
    </div>
</nav>

<div class="container" style="max-width: 900px;">

    <div class="text-center mb-5" id="searchSection">
        <h2 class="mb-3 text-secondary">é‡åˆ°ä»€éº¼ Incidentï¼Ÿ</h2>
        <input type="text" id="searchInput" class="form-control search-box rounded-pill" 
               placeholder="ğŸ” è¼¸å…¥é—œéµå­—æœå°‹ (ä¾‹å¦‚: payment, timeout, login...)" onkeyup="filterSOPs()">
        
        <div id="resultsArea" class="mt-4 text-start"></div>
    </div>

    <div id="executionSection" class="hidden">
        <button class="btn btn-link text-decoration-none mb-3" onclick="goBack()">â† è¿”å›æœå°‹çµæœ</button>
        
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white p-3">
                <h4 class="m-0" id="execTitle">Title</h4>
            </div>
            <div class="card-body p-4">
                <div id="stepsContainer"></div>
                
                <div id="reportBox" class="mt-4 p-3 bg-light border rounded hidden">
                    <h5 class="text-success">âœ… è™•ç†å®Œæˆ</h5>
                    <p class="text-muted small">è«‹è¤‡è£½ä»¥ä¸‹å…§å®¹å›è¦† ServiceNowï¼š</p>
                    <textarea id="finalOutput" class="form-control console-bg" rows="6"></textarea>
                    <button class="btn btn-success mt-2 w-100" onclick="copyText()">ğŸ“‹ ä¸€éµè¤‡è£½</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    let allSops = [];
    let currentSop = null;
    let logs = [];

    // åˆå§‹åŒ–ï¼šå˜—è©¦è®€å– data.json
    fetch('data.json')
        .then(res => res.json())
        .then(data => {
            allSops = data;
            renderList(allSops); // åˆå§‹é¡¯ç¤ºæ‰€æœ‰
        })
        .catch(err => {
            console.warn("æ‰¾ä¸åˆ° data.jsonï¼Œä½¿ç”¨å…§å»ºæ¨¡æ“¬è³‡æ–™");
            // é€™è£¡ç‚ºäº†é˜²æ­¢ä½ å¿˜è¨˜æ”¾ jsonï¼Œç›´æ¥å¯«å…¥å‚™ç”¨è³‡æ–™
            allSops = [
                { title: "ğŸ”´ [Example] Payment Timeout", tags: ["payment"], steps: [{type:"info", title:"Check Log", desc:"Run grep..."}] }
            ];
            renderList(allSops);
        });

    // æœå°‹éæ¿¾åŠŸèƒ½
    function filterSOPs() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allSops.filter(sop => {
            // æœå°‹æ¨™é¡Œ + Tags
            return sop.title.toLowerCase().includes(term) || 
                   (sop.tags && sop.tags.some(t => t.toLowerCase().includes(term)));
        });
        renderList(filtered);
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderList(list) {
        const area = document.getElementById('resultsArea');
        area.innerHTML = '';
        if(list.length === 0) {
            area.innerHTML = '<div class="text-center text-muted">æ²’æœ‰æ‰¾åˆ°ç›¸é—œ SOP ğŸ˜… <br> <a href="editor.html">å»æ–°å¢ä¸€å€‹ï¼Ÿ</a></div>';
            return;
        }
        list.forEach((sop, index) => {
            // æ‰¾å‡ºåŸå§‹ index ä»¥ä¾¿æ­£ç¢ºå‚³é
            const realIndex = allSops.indexOf(sop); 
            area.innerHTML += `
                <div class="card sop-card mb-3 p-3" onclick="startSOP(${realIndex})">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="m-0">${sop.title}</h5>
                        <span class="badge bg-secondary">é–‹å§‹æ’æŸ¥ &gt;</span>
                    </div>
                    <small class="text-muted mt-1">Tags: ${sop.tags ? sop.tags.join(', ') : 'none'}</small>
                </div>
            `;
        });
    }

    // é–‹å§‹åŸ·è¡Œ SOP
    function startSOP(index) {
        currentSop = allSops[index];
        logs = [`Starting Incident Handling: ${currentSop.title}`];
        
        document.getElementById('searchSection').classList.add('hidden');
        document.getElementById('executionSection').classList.remove('hidden');
        document.getElementById('execTitle').innerText = currentSop.title;
        document.getElementById('stepsContainer').innerHTML = '';
        document.getElementById('reportBox').classList.add('hidden');
        
        renderStep(0);
    }

    function renderStep(stepIdx) {
        if (stepIdx >= currentSop.steps.length) {
            finishSOP();
            return;
        }

        const step = currentSop.steps[stepIdx];
        const container = document.getElementById('stepsContainer');
        
        // å»ºç«‹ Step å¡ç‰‡
        const div = document.createElement('div');
        div.className = "mb-4 border-bottom pb-4 fade-in";
        div.id = `step-${stepIdx}`;
        
        let content = `<h5 class="text-primary">Step ${stepIdx + 1}: ${step.title}</h5>
                       <p>${step.desc}</p>`;

        // æ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒå…ƒä»¶
        if (step.type === 'command') {
            content += `<div class="console-bg mb-2">$ ${step.cmd}</div>
                        <input type="text" class="form-control mb-2" id="input-${stepIdx}" placeholder="è«‹è²¼ä¸Š Command Output...">
                        <button class="btn btn-primary btn-sm" onclick="nextStep(${stepIdx}, 'cmd')">ç¢ºèªä¸¦ä¸‹ä¸€æ­¥</button>`;
        } else if (step.type === 'decision') {
            content += `<div class="d-flex gap-2">`;
            step.options.forEach(opt => {
                content += `<button class="btn btn-outline-dark" onclick="nextStep(${stepIdx}, 'decision', '${opt}')">${opt}</button>`;
            });
            content += `</div>`;
        } else {
            content += `<button class="btn btn-primary btn-sm" onclick="nextStep(${stepIdx}, 'info')">ä¸‹ä¸€æ­¥</button>`;
        }

        div.innerHTML = content;
        container.appendChild(div);
        
        // æ»¾å‹•åˆ°åº•éƒ¨
        div.scrollIntoView({ behavior: 'smooth' });
    }

    function nextStep(idx, type, val) {
        // é–å®šä¸Šä¸€æ­¥
        const currentDiv = document.getElementById(`step-${idx}`);
        currentDiv.classList.add('step-completed');
        
        // ç´€éŒ„ Log
        const step = currentSop.steps[idx];
        let record = `[Step ${idx+1}] ${step.title}`;
        
        if (type === 'cmd') {
            const inputVal = document.getElementById(`input-${idx}`).value;
            record += `\n   > Output: ${inputVal}`;
        } else if (type === 'decision') {
            record += `\n   > Decision: ${val}`;
        }
        logs.push(record);

        // ä¸‹ä¸€æ­¥
        renderStep(idx + 1);
    }

    function finishSOP() {
        const report = `[Incident Report]\n${currentSop.title}\n\n[Investigation Log]\n${logs.join('\n')}\n\n[Status]\nResolved.`;
        document.getElementById('finalOutput').value = report;
        document.getElementById('reportBox').classList.remove('hidden');
        document.getElementById('reportBox').scrollIntoView({ behavior: 'smooth' });
    }

    function goBack() {
        document.getElementById('executionSection').classList.add('hidden');
        document.getElementById('searchSection').classList.remove('hidden');
    }

    function copyText() {
        const txt = document.getElementById('finalOutput');
        txt.select();
        document.execCommand('copy');
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    }
</script>
</body>
</html>
